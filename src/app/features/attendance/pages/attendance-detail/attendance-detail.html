<main class="main-container">
  <div class="flex mb-2 items-center gap-2 mt-4">
    <lucide-angular routerLink="/attendance" [img]="CornerDownLeft" [size]="32" class="cursor-pointer border border-text-300 rounded-md shadow-2xs shadow-text-300"></lucide-angular>
    <h1 class="text-2xl font-bold">{{ event?.name }}</h1>
  </div>
  <p routerLink="/attendance/{{slug}}/check-in" class="text-lg underline cursor-pointer">https://attendify.website/attendance/{{slug}}/check-in</p>

  <img [src]="event?.bannerImageUrl" alt="Attendance Banner" class="mt-3 rounded-xl"/>

  <section class="mt-4">
    <h1 class="font-bold text-xl">Attendance Overview</h1>
    <div class="w-full md:w-1/2 grid grid-cols-1 md:grid-cols-4 gap-4 -ml-2">
      <ngx-charts-number-card
        [scheme]="'aqua'"
        [results]="overviewData" 
        [cardColor]="'#3A445D'"
        (select)="onCardClick($event)"
        [animations]="false"
      ></ngx-charts-number-card>
    </div>
  </section>  
  <section class="mt-2">
    <h1 class="font-bold text-xl">Overall Checked In Attendees (Actual)</h1>
    <mat-form-field appearance="outline" class="my-2 w-full md:w-72">
      <mat-label>Enter a date</mat-label>
      <input matInput [matDatepicker]="dp" [formControl]="date">
      <mat-hint>MMMM DD, YYYY</mat-hint>
      <mat-datepicker-toggle matIconSuffix [for]="dp"></mat-datepicker-toggle>
      <mat-datepicker #dp></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" class="w-full mb-4 mt-2">
      <mat-label>Filter</mat-label>
      <input matInput (keydown.enter)="onSearchAttendanceRecord($event)" placeholder="Type a name to search...">
    </mat-form-field>

    @if (attendance.loading) {
      <div class="flex flex-col items-center gap-4 backdrop-blur-md text-text-300 rounded-lg">
        <img src="assets/gifs/neon-cat.gif" alt="Neon Cat" class="h-40 rounded-md shadow-lg shadow-monochromatic-dark">
        <p class="font-semibold">Calculating solar flare impact . . .</p>
      </div>
    }

    @if (attendance.errorMessage && !attendance.loading) {
      <div class="text-center text-text-300 p-4">
        {{ attendance.errorMessage }}
      </div>
    }

    @if (attendance.empty && !attendance.loading && !attendance.errorMessage) {
      <app-error-card
        [statusCode]="204"
        title="Content Not Found"
        message="No attendance records found for this date."
        imageUrl="/assets/http.cat/204.jpeg"
      ></app-error-card>
    }

    <div class="overflow-x-auto">
      @if (!attendance.loading && !attendance.errorMessage && !attendance.empty)  {
        <table cdk-table [dataSource]="attendanceDataSource" class="min-w-[650px] w-full border border-text-300 rounded-md">
          <ng-container cdkColumnDef="fullName">
            <th cdk-header-cell *cdkHeaderCellDef class="bg-[#067BC3] text-left pl-6 py-3 text-white">Full Name</th>
            <td cdk-cell *cdkCellDef="let element" class="bg-monochromatic-light text-left pl-6 py-3 text-text-900 font-bold border-t border-text-300 capitalize">
              {{element.attendee.firstName}} {{element.attendee.lastName}} 
            </td>
          </ng-container>

          <ng-container cdkColumnDef="primaryLeader">
            <th cdk-header-cell *cdkHeaderCellDef class="bg-[#067BC3] text-left py-3 text-white">Primary Leader</th>
            <td cdk-cell *cdkCellDef="let element" class="bg-monochromatic-light text-left py-3 text-text-900 border-t border-text-300">
              {{ element.attendee.primaryLeader ? (element.attendee.primaryLeader.firstName + " " + element.attendee.primaryLeader.lastName) : '-' }}
            </td>
          </ng-container>

          <ng-container cdkColumnDef="churchProcess">
            <th cdk-header-cell *cdkHeaderCellDef class="bg-[#067BC3] text-left py-3 text-white">Church Process</th>
            <td cdk-cell *cdkCellDef="let element" class="bg-monochromatic-light text-left py-3 text-text-900 border-t border-text-300">
              {{element.attendee.churchProcess || '-'}} 
            </td>
          </ng-container>

          <ng-container cdkColumnDef="memberStatus">
            <th cdk-header-cell *cdkHeaderCellDef class="bg-[#067BC3] text-left py-3 text-white">Member Status</th>
            <td cdk-cell *cdkCellDef="let element" class="bg-monochromatic-light text-left py-3 text-text-900 border-t border-text-300"> 
              {{element.attendee.memberStatus || '-'}} 
            </td>
          </ng-container>

          <ng-container cdkColumnDef="arival">
            <th cdk-header-cell *cdkHeaderCellDef class="w-36 bg-[#067BC3] text-end pr-6 py-3 text-white">Arrival</th>
            <td cdk-cell *cdkCellDef="let element" class="w-36 bg-monochromatic-light py-3 text-text-900 border-t border-text-300">
              <div class="flex items-center justify-end gap-4 mr-6">
                {{element.timeIn | date: 'shortTime'}} 
                <div 
                  class="w-2.5 h-2.5 rounded-full"
                  [ngClass]="{
                    'bg-danger-900': element.isLate,
                    'bg-success-900': !element.isLate
                  }"
                ></div>
              </div>
            </td>
          </ng-container>

          <tr cdk-header-row *cdkHeaderRowDef="displayedColumns"></tr>
          <tr cdk-row *cdkRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      }
      
      <mat-paginator
        #checkedInPaginator
        [length]="attendance.totalCount"
        [pageSize]="pageLimit" 
        [pageSizeOptions]="[5, 10, 25, 50]" 
        aria-label="Select attendance page"
        (page)="onPageChange($event)"
      ></mat-paginator>
    </div>
  </section>
</main>